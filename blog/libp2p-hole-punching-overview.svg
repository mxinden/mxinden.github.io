<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1421px" preserveAspectRatio="none" style="width:1010px;height:1421px;" version="1.1" viewBox="0 0 1010 1421" width="1010px" zoomAndPan="magnify"><defs><filter height="300%" id="f1h16smq87nu87" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="1407.8906" style="stroke: #000000; stroke-width: 1.0;" width="996.5" x="3" y="3"/><path d="M478,4 L478,12.2969 L468,22.2969 L3,22.2969 " fill="none" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="465" x="6" y="16.9951">Goal: Peer A establishes a direct connection to non-dialable peer B.</text><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="352.8828" style="stroke: #000000; stroke-width: 2.0;" width="476" x="487.5" y="128.7266"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="390" x="497.5" y="212.2578"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="202.0859" style="stroke: #000000; stroke-width: 2.0;" width="386" x="497.5" y="272.5234"/><rect fill="#FFFFFF" height="87.0078" style="stroke: none; stroke-width: 1.0;" width="386" x="497.5" y="387.6016"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="485" x="497.5" y="495.6094"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="179.9297" style="stroke: #000000; stroke-width: 2.0;" width="606.5" x="277" y="585.0078"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="104.5313" style="stroke: #000000; stroke-width: 2.0;" width="427" x="287" y="609.1406"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="223.0625" style="stroke: #000000; stroke-width: 2.0;" width="459.5" x="96" y="822.0703"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="133.6641" style="stroke: #000000; stroke-width: 2.0;" width="439.5" x="106" y="875.3359"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="292.4609" style="stroke: #000000; stroke-width: 2.0;" width="693" x="18" y="1059.1328"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="261.3281" style="stroke: #000000; stroke-width: 2.0;" width="527.5" x="28" y="1083.2656"/><rect fill="#FFFFFF" filter="url(#f1h16smq87nu87)" height="137.6641" style="stroke: #000000; stroke-width: 2.0;" width="507.5" x="38" y="1107.3984"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="129" x2="129" y1="68.5938" y2="1368.5938"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="324" x2="324" y1="68.5938" y2="1368.5938"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="521.5" x2="521.5" y1="68.5938" y2="1368.5938"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="819.5" x2="819.5" y1="68.5938" y2="1368.5938"/><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="23" x="116" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="9" x="123" y="53.292">A</text><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="23" x="116" y="1367.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="9" x="123" y="1387.5889">A</text><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="297" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="304" y="53.292">Relay</text><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="297" y="1367.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="304" y="1387.5889">Relay</text><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="507.5" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="514.5" y="53.292">B</text><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="507.5" y="1367.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="10" x="514.5" y="1387.5889">B</text><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="769.5" y="29.2969"/><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="765.5" y="33.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="772.5" y="53.292">Other_Peers</text><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="769.5" y="1367.5938"/><rect fill="#FEFECE" filter="url(#f1h16smq87nu87)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="765.5" y="1371.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="772.5" y="1391.5889">Other_Peers</text><rect fill="#EEEEEE" filter="url(#f1h16smq87nu87)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="984.5" x="8" y="99.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="992.5" y1="99.1602" y2="99.1602"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="992.5" y1="102.1602" y2="102.1602"/><rect fill="#EEEEEE" filter="url(#f1h16smq87nu87)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="180" x="410.25" y="88.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="161" x="416.25" y="104.6606">Phase 1 - Preparation</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="582.25" y="104.6606"/><path d="M487.5,128.7266 L958.5,128.7266 L958.5,135.7266 L948.5,145.7266 L487.5,145.7266 L487.5,128.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="352.8828" style="stroke: #000000; stroke-width: 2.0;" width="476" x="487.5" y="128.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="426" x="502.5" y="141.7935">B determining whether it is dialable via AutoNAT protocol</text><polygon fill="#A80036" points="807.5,193.2578,817.5,197.2578,807.5,201.2578,811.5,197.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="521.5" x2="813.5" y1="197.2578" y2="197.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="528.5" y="161.9263">DialRequest {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="536.5" y="177.0591">supposedly_public_addresses</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="528.5" y="192.1919">}</text><path d="M497.5,212.2578 L882.5,212.2578 L882.5,219.2578 L872.5,229.2578 L497.5,229.2578 L497.5,212.2578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="46.2656" style="stroke: #000000; stroke-width: 2.0;" width="390" x="497.5" y="212.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="512.5" y="225.3247">For each provided supposedly public address</text><polygon fill="#A80036" points="532.5,246.5234,522.5,250.5234,532.5,254.5234,528.5,250.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="526.5" x2="818.5" y1="250.5234" y2="250.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="538.5" y="245.4575">Dial</text><path d="M497.5,272.5234 L561.5,272.5234 L561.5,279.5234 L551.5,289.5234 L497.5,289.5234 L497.5,272.5234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="202.0859" style="stroke: #000000; stroke-width: 2.0;" width="386" x="497.5" y="272.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="512.5" y="285.5903">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="185" x="576.5" y="284.7339">[One of the dials succeeded.</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="298" x="576.5" y="297.5386">Thus B is dialable. No need for Hole Punching.</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="576.5" y="310.3433">Don't continue.]</text><polygon fill="#A80036" points="532.5,375.6016,522.5,379.6016,532.5,383.6016,528.5,379.6016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="526.5" x2="818.5" y1="379.6016" y2="379.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="538.5" y="329.1372">DialOutcome {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="546.5" y="344.27">"Ok"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="546.5" y="359.4028">successful_address</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="538.5" y="374.5356">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="497.5" x2="883.5" y1="388.6016" y2="388.6016"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="192" x="502.5" y="398.812">[None of the dials succeeded.</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="339" x="502.5" y="411.6167">Thus not dialable. Hole Punching needed. Continue.]</text><polygon fill="#A80036" points="532.5,462.6094,522.5,466.6094,532.5,470.6094,528.5,466.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="526.5" x2="818.5" y1="466.6094" y2="466.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="538.5" y="431.2778">DialOutcome {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="546.5" y="446.4106">"Error"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="538.5" y="461.5435">}</text><path d="M497.5,495.6094 L977.5,495.6094 L977.5,502.6094 L967.5,512.6094 L497.5,512.6094 L497.5,495.6094 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="75.3984" style="stroke: #000000; stroke-width: 2.0;" width="485" x="497.5" y="495.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="435" x="512.5" y="508.6763">B finding closest public Relay nodes via Kademlia Protocol</text><polygon fill="#A80036" points="807.5,529.875,817.5,533.875,807.5,537.875,811.5,533.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="521.5" x2="813.5" y1="533.875" y2="533.875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="528.5" y="528.8091">FindNodes(PEER_ID_B)</text><polygon fill="#A80036" points="532.5,559.0078,522.5,563.0078,532.5,567.0078,528.5,563.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="526.5" x2="818.5" y1="563.0078" y2="563.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="538.5" y="557.9419">[ Public nodes closest to PEER_ID_B ]</text><path d="M277,585.0078 L719,585.0078 L719,592.0078 L709,602.0078 L277,602.0078 L277,585.0078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="179.9297" style="stroke: #000000; stroke-width: 2.0;" width="606.5" x="277" y="585.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="397" x="292" y="598.0747">B listening for incoming connections via closest Relay</text><path d="M287,609.1406 L709,609.1406 L709,616.1406 L699,626.1406 L287,626.1406 L287,609.1406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="104.5313" style="stroke: #000000; stroke-width: 2.0;" width="427" x="287" y="609.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="377" x="302" y="622.2075">For each closest Relay via Circuit Relay v2 Protocol</text><polygon fill="#A80036" points="335.5,643.4063,325.5,647.4063,335.5,651.4063,331.5,647.4063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329.5" x2="520.5" y1="647.4063" y2="647.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="341.5" y="642.3403">Establish connection</text><polygon fill="#A80036" points="335.5,672.5391,325.5,676.5391,335.5,680.5391,331.5,676.5391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329.5" x2="520.5" y1="676.5391" y2="676.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="341.5" y="671.4731">Request reservation</text><polygon fill="#A80036" points="509.5,701.6719,519.5,705.6719,509.5,709.6719,513.5,705.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="515.5" y1="705.6719" y2="705.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="331.5" y="700.606">Accept reservation</text><polygon fill="#A80036" points="807.5,752.9375,817.5,756.9375,807.5,760.9375,811.5,756.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="521.5" x2="813.5" y1="756.9375" y2="756.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="528.5" y="736.7388">Advertise oneself as</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="528.5" y="751.8716">/&lt;RELAY_ADDR&gt;/p2p-circuit/&lt;PEER_ID_B&gt;</text><rect fill="#EEEEEE" filter="url(#f1h16smq87nu87)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="984.5" x="8" y="792.5039"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="992.5" y1="792.5039" y2="792.5039"/><line style="stroke: #000000; stroke-width: 1.0;" x1="8" x2="992.5" y1="795.5039" y2="795.5039"/><rect fill="#EEEEEE" filter="url(#f1h16smq87nu87)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="199" x="400.75" y="781.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="180" x="406.75" y="798.0044">Phase 2 - Hole Punching</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="591.75" y="798.0044"/><path d="M96,822.0703 L403,822.0703 L403,829.0703 L393,839.0703 L96,839.0703 L96,822.0703 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="223.0625" style="stroke: #000000; stroke-width: 2.0;" width="459.5" x="96" y="822.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="262" x="111" y="835.1372">A establish relayed connection to B</text><polygon fill="#A80036" points="312.5,856.3359,322.5,860.3359,312.5,864.3359,316.5,860.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="129.5" x2="318.5" y1="860.3359" y2="860.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="136.5" y="855.27">Establish Connection</text><path d="M106,875.3359 L331,875.3359 L331,882.3359 L321,892.3359 L106,892.3359 L106,875.3359 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="133.6641" style="stroke: #000000; stroke-width: 2.0;" width="439.5" x="106" y="875.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="121" y="888.4028">Circuit Relay v2 Protocol</text><polygon fill="#A80036" points="312.5,909.6016,322.5,913.6016,312.5,917.6016,316.5,913.6016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="129.5" x2="318.5" y1="913.6016" y2="913.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="136.5" y="908.5356">Request connection to B</text><polygon fill="#A80036" points="509.5,938.7344,519.5,942.7344,509.5,946.7344,513.5,942.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="324.5" x2="515.5" y1="942.7344" y2="942.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="331.5" y="937.6685">Request connection from A</text><polygon fill="#A80036" points="335.5,967.8672,325.5,971.8672,335.5,975.8672,331.5,971.8672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="329.5" x2="520.5" y1="971.8672" y2="971.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="341.5" y="966.8013">Accept connection request</text><polygon fill="#A80036" points="140.5,997,130.5,1001,140.5,1005,136.5,1001" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="134.5" x2="323.5" y1="1001" y2="1001"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="146.5" y="995.9341">Accept connection request</text><polygon fill="#A80036" points="140.5,1033.1328,130.5,1037.1328,140.5,1041.1328,136.5,1037.1328" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="509.5,1033.1328,519.5,1037.1328,509.5,1041.1328,513.5,1037.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="134.5" x2="515.5" y1="1037.1328" y2="1037.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="146.5" y="1032.0669">Relayed Connection established</text><path d="M18,1059.1328 L706,1059.1328 L706,1066.1328 L696,1076.1328 L18,1076.1328 L18,1059.1328 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="292.4609" style="stroke: #000000; stroke-width: 2.0;" width="693" x="18" y="1059.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="643" x="33" y="1072.1997">A and B coordinate dial via Direct Connection Upgrade through Relay (DCUtR) Protocol</text><path d="M28,1083.2656 L105,1083.2656 L105,1090.2656 L95,1100.2656 L28,1100.2656 L28,1083.2656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="261.3281" style="stroke: #000000; stroke-width: 2.0;" width="527.5" x="28" y="1083.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="43" y="1096.3325">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="120" y="1095.4761">[Until direct connection established]</text><path d="M38,1107.3984 L251,1107.3984 L251,1114.3984 L241,1124.3984 L38,1124.3984 L38,1107.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="137.6641" style="stroke: #000000; stroke-width: 2.0;" width="507.5" x="38" y="1107.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="53" y="1120.4653">Via relayed connection</text><polygon fill="#A80036" points="509.5,1141.6641,519.5,1145.6641,509.5,1149.6641,513.5,1145.6641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="129.5" x2="515.5" y1="1145.6641" y2="1145.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="136.5" y="1140.5981">Connect { addresses }</text><rect fill="#FBFB77" filter="url(#f1h16smq87nu87)" height="23" style="stroke: #A80036; stroke-width: 1.0;" width="163" x="48" y="1158.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="52" y="1174.731">Measure round-trip time</text><polygon fill="#A80036" points="140.5,1203.9297,130.5,1207.9297,140.5,1211.9297,136.5,1207.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="134.5" x2="520.5" y1="1207.9297" y2="1207.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="146.5" y="1202.8638">Connect { addresses }</text><polygon fill="#A80036" points="509.5,1233.0625,519.5,1237.0625,509.5,1241.0625,513.5,1237.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="129.5" x2="515.5" y1="1237.0625" y2="1237.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="136.5" y="1231.9966">Sync</text><rect fill="#FBFB77" filter="url(#f1h16smq87nu87)" height="53" style="stroke: #A80036; stroke-width: 1.0;" width="414" x="118" y="1257.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="208.75" y="1273.1294">Simultaneously establish connection</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="208.75" y="1288.2622">- A after 1/2 RTT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="208.75" y="1303.395">- B when receiving Sync</text><polygon fill="#A80036" points="140.5,1332.5938,130.5,1336.5938,140.5,1340.5938,136.5,1336.5938" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="509.5,1332.5938,519.5,1336.5938,509.5,1340.5938,513.5,1336.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="134.5" x2="515.5" y1="1336.5938" y2="1336.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="146.5" y="1331.5278">Attempt direct connection / Hole Punch</text><!--MD5=[e683e87ddf6161985c433c13099982b6]
@startuml
participant A
participant Relay
participant B
collections Other_Peers

mainframe Goal: Peer A establishes a direct connection to non-dialable peer B.

== __Phase 1 - Preparation__ ==

group B determining whether it is dialable via AutoNAT protocol
        B -> Other_Peers: DialRequest {\n  supposedly_public_addresses\n}
        group For each provided supposedly public address
                Other_Peers -> B: Dial
        end
        alt One of the dials succeeded.\nThus B is dialable. No need for Hole Punching.\nDon't continue.
                Other_Peers -> B: DialOutcome {\n  "Ok"\n  successful_address\n}
        else None of the dials succeeded.\nThus not dialable. Hole Punching needed. Continue.
                Other_Peers -> B: DialOutcome {\n  "Error"\n}
        end
end

group B finding closest public Relay nodes via Kademlia Protocol
        B -> Other_Peers: FindNodes(PEER_ID_B) 
        Other_Peers -> B: [ Public nodes closest to PEER_ID_B ]
end

group B listening for incoming connections via closest Relay
        group For each closest Relay via Circuit Relay v2 Protocol
                B -> Relay: Establish connection
                B -> Relay: Request reservation
                Relay -> B: Accept reservation
        end
        B -> Other_Peers: Advertise oneself as\n/<RELAY_ADDR>/p2p-circuit/<PEER_ID_B>
end

== __Phase 2 - Hole Punching__ ==

group A establish relayed connection to B

        A -> Relay: Establish Connection
        group Circuit Relay v2 Protocol
                A -> Relay: Request connection to B
                Relay -> B: Request connection from A
                B -> Relay: Accept connection request
                Relay -> A: Accept connection request
        end

        A <-> B: **Relayed Connection established**

end

group A and B coordinate dial via Direct Connection Upgrade through Relay (DCUtR) Protocol
        loop Until direct connection established
                group Via relayed connection
                        A -> B: Connect { addresses }
                        rnote over A: Measure round-trip time
                        B -> A: Connect { addresses }
                        A -> B: Sync
                end
                rnote over A, B: Simultaneously establish connection\n- A after 1/2 RTT\n- B when receiving Sync
                A <-> B: **Attempt direct connection / Hole Punch**
        end
end

@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.14+9-post-Debian-1deb11u1
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>